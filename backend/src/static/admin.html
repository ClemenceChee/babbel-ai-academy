<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B____ AI Academy - Content Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">B</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h1 class="text-xl font-semibold text-gray-900">B____ AI Academy</h1>
                            <p class="text-sm text-gray-500">Content Management System</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-orange-600 hover:text-orange-800">← Back to Academy</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div v-if="loading" class="flex items-center justify-center py-12">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading courses...</p>
            </div>
        </div>

        <!-- Main Content -->
        <div v-else class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Course Selection -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Course Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="course in courses" :key="course.id" 
                         class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 cursor-pointer hover:shadow-md transition-shadow"
                         @click="selectCourse(course)">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                                <span class="text-orange-600 font-bold">{{ course.id }}</span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">{{ course.title }}</h3>
                                <p class="text-sm text-gray-500">{{ course.track }} • {{ course.duration }}</p>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm">{{ course.description }}</p>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <span v-for="tag in course.tags" :key="tag" 
                                  class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">
                                {{ tag }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Editor -->
            <div v-if="selectedCourse" class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">
                            Editing: {{ selectedCourse.title }}
                        </h3>
                        <div class="flex space-x-3">
                            <button @click="saveCourse" 
                                    :disabled="saving"
                                    class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 disabled:opacity-50">
                                <span v-if="saving">Saving...</span>
                                <span v-else>Save Changes</span>
                            </button>
                            <button @click="selectedCourse = null" 
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                Close
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <!-- Course Basic Info -->
                    <div class="mb-8">
                        <h4 class="text-md font-semibold text-gray-900 mb-4">Course Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input v-model="selectedCourse.title" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                                <input v-model="selectedCourse.duration" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Level</label>
                                <select v-model="selectedCourse.level" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option>Beginner</option>
                                    <option>Intermediate</option>
                                    <option>Advanced</option>
                                    <option>Executive</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Track</label>
                                <select v-model="selectedCourse.track" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option>Leadership</option>
                                    <option>Compliance</option>
                                    <option>Product</option>
                                    <option>Developer</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea v-model="selectedCourse.description" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Lessons -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-semibold text-gray-900">Lessons</h4>
                            <button @click="addLesson" 
                                    class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                                Add Lesson
                            </button>
                        </div>
                        
                        <div v-for="(lesson, lessonIndex) in selectedCourse.lessons" :key="lesson.id" 
                             class="border border-gray-200 rounded-lg mb-4">
                            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                <h5 class="font-medium text-gray-900">{{ lesson.title }}</h5>
                                <div class="flex space-x-2">
                                    <button @click="toggleLesson(lessonIndex)" 
                                            class="text-orange-600 hover:text-orange-800 text-sm">
                                        {{ expandedLessons[lessonIndex] ? 'Collapse' : 'Expand' }}
                                    </button>
                                    <button @click="removeLesson(lessonIndex)" 
                                            class="text-red-600 hover:text-red-800 text-sm">
                                        Remove
                                    </button>
                                </div>
                            </div>
                            
                            <div v-if="expandedLessons[lessonIndex]" class="p-4">
                                <!-- Lesson Basic Info -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Lesson Title</label>
                                        <input v-model="lesson.title" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Duration</label>
                                        <input v-model="lesson.duration" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <textarea v-model="lesson.description" rows="2"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                                    </div>
                                </div>

                                <!-- Content Editor -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Lesson Content (HTML)</label>
                                    <textarea v-model="lesson.content" rows="20"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 font-mono text-sm"
                                              placeholder="Enter HTML content for this lesson..."></textarea>
                                    <p class="text-xs text-gray-500 mt-1">You can use HTML tags, tables, images, and inline styles.</p>
                                </div>

                                <!-- Content Preview -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Content Preview</label>
                                    <div class="border border-gray-300 rounded-md p-4 bg-gray-50 max-h-96 overflow-y-auto">
                                        <div v-html="lesson.content" class="prose prose-orange max-w-none"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div v-if="message" class="fixed bottom-4 right-4 max-w-sm z-50">
            <div :class="messageType === 'success' ? 'bg-green-500' : 'bg-red-500'" 
                 class="text-white px-6 py-3 rounded-lg shadow-lg">
                {{ message }}
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    courses: [],
                    selectedCourse: null,
                    expandedLessons: {},
                    message: '',
                    messageType: 'success',
                    loading: true,
                    saving: false
                }
            },
            async mounted() {
                await this.loadCourses();
            },
            methods: {
                async loadCourses() {
                    try {
                        this.loading = true;
                        const courseIds = [1, 2, 3, 4, 5, 6];
                        const coursePromises = courseIds.map(async (id) => {
                            try {
                                const response = await fetch(`/api/courses/${id}`);
                                const result = await response.json();
                                if (result.success) {
                                    return result.data;
                                }
                                return null;
                            } catch (error) {
                                console.error(`Failed to load course ${id}:`, error);
                                return null;
                            }
                        });
                        
                        const courses = await Promise.all(coursePromises);
                        this.courses = courses.filter(course => course !== null);
                    } catch (error) {
                        this.showMessage('Failed to load courses', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                async selectCourse(course) {
                    try {
                        this.loading = true;
                        const response = await fetch(`/api/courses/${course.id}`);
                        const result = await response.json();
                        if (result.success) {
                            this.selectedCourse = JSON.parse(JSON.stringify(result.data));
                            this.expandedLessons = {};
                            
                            // Load lesson content for each lesson
                            for (let i = 0; i < this.selectedCourse.lessons.length; i++) {
                                const lesson = this.selectedCourse.lessons[i];
                                try {
                                    const lessonResponse = await fetch(`/api/courses/${course.id}/lessons/${lesson.id}`);
                                    const lessonResult = await lessonResponse.json();
                                    if (lessonResult.success && lessonResult.data.modules) {
                                        // Combine modules content into a single content field for editing
                                        let combinedContent = '';
                                        lessonResult.data.modules.forEach(module => {
                                            combinedContent += `<div class="mb-8">
                                                <h3 class="text-xl font-bold text-gray-900 mb-4">${module.title}</h3>
                                                ${module.content}
                                            </div>`;
                                        });
                                        this.selectedCourse.lessons[i].content = combinedContent;
                                    } else {
                                        this.selectedCourse.lessons[i].content = '<div class="mb-6"><h3 class="text-lg font-semibold mb-4">New Lesson</h3><p class="mb-4">Lesson content goes here...</p></div>';
                                    }
                                } catch (error) {
                                    console.error('Failed to load lesson content:', error);
                                    this.selectedCourse.lessons[i].content = '<div class="mb-6"><h3 class="text-lg font-semibold mb-4">New Lesson</h3><p class="mb-4">Lesson content goes here...</p></div>';
                                }
                            }
                        }
                    } catch (error) {
                        this.showMessage('Failed to load course details', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                async saveCourse() {
                    try {
                        this.saving = true;
                        
                        // Save each lesson individually
                        for (const lesson of this.selectedCourse.lessons) {
                            const lessonData = {
                                id: lesson.id,
                                title: lesson.title,
                                description: lesson.description,
                                duration: lesson.duration,
                                modules: [
                                    {
                                        id: 1,
                                        title: lesson.title,
                                        content: lesson.content
                                    }
                                ]
                            };
                            
                            const response = await fetch(`/api/admin/courses/${this.selectedCourse.id}/lessons/${lesson.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(lessonData)
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to save lesson');
                            }
                        }
                        
                        // Save course metadata
                        const courseResponse = await fetch(`/api/admin/courses/${this.selectedCourse.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: this.selectedCourse.title,
                                description: this.selectedCourse.description,
                                duration: this.selectedCourse.duration,
                                level: this.selectedCourse.level,
                                track: this.selectedCourse.track,
                                tags: this.selectedCourse.tags
                            })
                        });
                        
                        if (courseResponse.ok) {
                            this.showMessage('Course saved successfully!', 'success');
                            await this.loadCourses();
                        } else {
                            throw new Error('Failed to save course metadata');
                        }
                    } catch (error) {
                        this.showMessage('Failed to save course: ' + error.message, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                toggleLesson(index) {
                    this.expandedLessons[index] = !this.expandedLessons[index];
                },
                addLesson() {
                    const newLesson = {
                        id: Date.now(),
                        title: 'New Lesson',
                        description: '',
                        duration: '1 hour',
                        content: '<div class="mb-6"><h3 class="text-lg font-semibold mb-4">New Lesson</h3><p class="mb-4">Lesson content goes here...</p></div>'
                    };
                    this.selectedCourse.lessons.push(newLesson);
                },
                removeLesson(index) {
                    if (confirm('Are you sure you want to remove this lesson?')) {
                        this.selectedCourse.lessons.splice(index, 1);
                    }
                },
                showMessage(text, type = 'success') {
                    this.message = text;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
